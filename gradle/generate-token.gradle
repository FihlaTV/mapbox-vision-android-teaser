//
// Configuration file for adding a developer-config.xml containing the MAPBOX_ACCESS_TOKEN env. variable.
//
task accessToken {
    def tokenDir = new File("${projectDir}/src/main/res/values")
    if (!tokenDir.exists()) {
        tokenDir.mkdir()
    }
    def tokenFile = new File("${projectDir}/src/main/res/values/developer-config.xml")
    String token
    if (!tokenFile.exists()) {
        // check env
        token = "$System.env.MAPBOX_ACCESS_TOKEN"
        if (token == "null") {
            token = ""
        }
        String tokenFileContents = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n" +
                "<!-- Please put your MAPBOX_ACCESS_TOKEN here -->\n" +
                "<resources>\n" +
                "    <string name=\"mapbox_access_token\">" + token + "</string>\n" +
                "</resources>"
        tokenFile.write(tokenFileContents)
    } else {
        def startPos = tokenFile.text.indexOf("mapbox_access_token") + "mapbox_access_token".length() + 2
        def endPos = tokenFile.text.indexOf("<", startPos)
        token = tokenFile.text.substring(startPos, endPos)
    }
    if (token == "") {
        throw new InvalidUserDataException("You haven't set MAPBOX_ACCESS_TOKEN.\n" +
                "Please set it in <module>/src/main/res/values/developer-config.xml")
    }
}

gradle.projectsEvaluated {
    preBuild.dependsOn('accessToken')
}
